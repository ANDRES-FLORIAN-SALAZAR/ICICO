<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n - Casa de Oraci√≥n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-cogs"></i> Panel de Administraci√≥n</h1>
                    <p>Casa de Oraci√≥n - Sistema de Gesti√≥n de Contenido</p>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-info btn-sm me-2" onclick="debugClean()" title="Limpieza con debug (no recarga)">
                        <i class="fas fa-bug me-2"></i>Debug
                    </button>
                    <button class="btn btn-outline-warning btn-sm me-2" onclick="emergencyClean()" title="Limpieza de emergencia">
                        <i class="fas fa-exclamation-triangle me-2"></i>Emergencia
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="showCleanDialog()" title="Eliminar todo el contenido">
                        <i class="fas fa-trash-alt me-2"></i>Limpiar Todo
                    </button>
                </div>
            </div>
        </div>

        <!-- Navegaci√≥n -->
        <div class="admin-card">
            <div class="btn-group w-100" role="group">
                <button class="btn-admin" onclick="showSection('anuncios')">
                    <i class="fas fa-bullhorn"></i> Anuncios
                </button>
                <button class="btn-admin" onclick="showSection('eventos')">
                    <i class="fas fa-calendar"></i> Eventos
                </button>
                <button class="btn-admin" onclick="showSection('predicas')">
                    <i class="fas fa-book"></i> Predicaciones
                </button>
                <button class="btn-admin" onclick="showSection('galeria')">
                    <i class="fas fa-images"></i> Galer√≠a
                </button>
            </div>
        </div>

        <!-- Secci√≥n de Anuncios -->
        <div id="anuncios" class="content-section">
            <div class="admin-card">
                <h3><i class="fas fa-bullhorn"></i> Gesti√≥n de Anuncios</h3>
                <form id="anuncioForm">
                    <div class="form-group">
                        <label for="anuncioTitulo">T√≠tulo del Anuncio</label>
                        <input type="text" class="form-control" id="anuncioTitulo" required>
                    </div>
                    <div class="form-group">
                        <label for="anuncioContenido">Contenido</label>
                        <textarea class="form-control" id="anuncioContenido" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="anuncioFecha">Fecha</label>
                        <input type="date" class="form-control" id="anuncioFecha" required>
                    </div>
                    <button type="submit" class="btn-admin">
                        <i class="fas fa-save"></i> Guardar Anuncio
                    </button>
                </form>
                
                <hr>
                <h4>Anuncios Existentes</h4>
                <div id="anunciosList"></div>
            </div>
        </div>

        <!-- Modal de Edici√≥n de Anuncio -->
        <div class="modal fade" id="editAnuncioModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Anuncio</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editAnuncioForm">
                            <input type="hidden" id="editAnuncioId">
                            <div class="form-group">
                                <label for="editAnuncioTitulo">T√≠tulo del Anuncio</label>
                                <input type="text" class="form-control" id="editAnuncioTitulo" required>
                            </div>
                            <div class="form-group">
                                <label for="editAnuncioContenido">Contenido</label>
                                <textarea class="form-control" id="editAnuncioContenido" rows="4" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="editAnuncioFecha">Fecha</label>
                                <input type="date" class="form-control" id="editAnuncioFecha" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="updateAnuncio()">Guardar Cambios</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Eventos -->
        <div id="eventos" class="content-section">
            <div class="admin-card">
                <h3><i class="fas fa-calendar"></i> Gesti√≥n de Eventos</h3>
                <form id="eventoForm">
                    <div class="form-group">
                        <label for="eventoTitulo">T√≠tulo del Evento</label>
                        <input type="text" class="form-control" id="eventoTitulo" required>
                    </div>
                    <div class="form-group">
                        <label for="eventoDescripcion">Descripci√≥n</label>
                        <textarea class="form-control" id="eventoDescripcion" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="eventoFecha">Fecha</label>
                        <input type="date" class="form-control" id="eventoFecha" required>
                    </div>
                    <div class="form-group">
                        <label for="eventoHora">Hora</label>
                        <input type="time" class="form-control" id="eventoHora" required>
                    </div>
                    <button type="submit" class="btn-admin">
                        <i class="fas fa-save"></i> Guardar Evento
                    </button>
                </form>
                
                <hr>
                <h4>Eventos Existentes</h4>
                <div id="eventosList"></div>
            </div>
        </div>

        <!-- Modal de Edici√≥n de Evento -->
        <div class="modal fade" id="editEventoModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Evento</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editEventoForm">
                            <input type="hidden" id="editEventoId">
                            <div class="form-group">
                                <label for="editEventoTitulo">T√≠tulo del Evento</label>
                                <input type="text" class="form-control" id="editEventoTitulo" required>
                            </div>
                            <div class="form-group">
                                <label for="editEventoDescripcion">Descripci√≥n</label>
                                <textarea class="form-control" id="editEventoDescripcion" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="editEventoFecha">Fecha</label>
                                <input type="date" class="form-control" id="editEventoFecha" required>
                            </div>
                            <div class="form-group">
                                <label for="editEventoHora">Hora</label>
                                <input type="time" class="form-control" id="editEventoHora" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="updateEvento()">Guardar Cambios</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Predicaciones -->
        <div id="predicas" class="content-section">
            <div class="admin-card">
                <h3><i class="fas fa-book"></i> Gesti√≥n de Predicaciones</h3>
                <form id="predicaForm">
                    <div class="form-group">
                        <label for="predicaTitulo">T√≠tulo de la Predicaci√≥n</label>
                        <input type="text" class="form-control" id="predicaTitulo" required>
                    </div>
                    <div class="form-group">
                        <label for="predicaPredicador">Predicador</label>
                        <input type="text" class="form-control" id="predicaPredicador" required>
                    </div>
                    <div class="form-group">
                        <label for="predicaFecha">Fecha</label>
                        <input type="date" class="form-control" id="predicaFecha" required>
                    </div>
                    <div class="form-group">
                        <label for="predicaDescripcion">Descripci√≥n</label>
                        <textarea class="form-control" id="predicaDescripcion" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn-admin">
                        <i class="fas fa-save"></i> Guardar Predicaci√≥n
                    </button>
                </form>
                
                <hr>
                <h4>Predicaciones Existentes</h4>
                <div id="predicasList"></div>
            </div>
        </div>

        <!-- Modal de Edici√≥n de Predicaci√≥n -->
        <div class="modal fade" id="editPredicaModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Predicaci√≥n</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editPredicaForm">
                            <input type="hidden" id="editPredicaId">
                            <div class="form-group">
                                <label for="editPredicaTitulo">T√≠tulo de la Predicaci√≥n</label>
                                <input type="text" class="form-control" id="editPredicaTitulo" required>
                            </div>
                            <div class="form-group">
                                <label for="editPredicaPredicador">Predicador</label>
                                <input type="text" class="form-control" id="editPredicaPredicador" required>
                            </div>
                            <div class="form-group">
                                <label for="editPredicaFecha">Fecha</label>
                                <input type="date" class="form-control" id="editPredicaFecha" required>
                            </div>
                            <div class="form-group">
                                <label for="editPredicaDescripcion">Descripci√≥n</label>
                                <textarea class="form-control" id="editPredicaDescripcion" rows="3" required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="updatePredica()">Guardar Cambios</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Galer√≠a -->
        <div id="galeria" class="content-section">
            <div class="admin-card">
                <h3><i class="fas fa-images"></i> Gesti√≥n de Galer√≠a</h3>
                
                <!-- Estad√≠sticas de Almacenamiento -->
                <div class="mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h5><i class="fas fa-database me-2"></i>Estad√≠sticas de Almacenamiento</h5>
                            <div id="storageStats">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Espacio Total</h6>
                                            <span id="totalSpace" class="badge bg-primary">Calculando...</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Usado</h6>
                                            <span id="usedSpace" class="badge bg-warning">Calculando...</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Disponible</h6>
                                            <span id="availableSpace" class="badge bg-success">Calculando...</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <h6>Uso</h6>
                                            <span id="usagePercentage" class="badge bg-info">Calculando...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <form id="galeriaForm">
                    <div class="form-group">
                        <label for="galeriaTitulo">T√≠tulo</label>
                        <input type="text" class="form-control" id="galeriaTitulo" required>
                    </div>
                    <div class="form-group">
                        <label for="galeriaDescripcion">Descripci√≥n</label>
                        <textarea class="form-control" id="galeriaDescripcion" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="galeriaTipo">Tipo</label>
                        <select class="form-control" id="galeriaTipo" required>
                            <option value="imagen">Imagen</option>
                            <option value="video">Video</option>
                            <option value="documento">Documento</option>
                            <option value="audio">Audio</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="galeriaArchivo">
                            <i class="fas fa-upload me-2"></i>Subir Archivo (Sin l√≠mites de tama√±o)
                        </label>
                        <input type="file" class="form-control" id="galeriaArchivo" accept="*/*">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Soporta archivos de cualquier tama√±o. Los archivos grandes se procesar√°n autom√°ticamente en partes.
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="galeriaUrl">URL del Archivo (opcional)</label>
                        <input type="url" class="form-control" id="galeriaUrl" placeholder="https://...">
                        <small class="text-muted">Si no subes un archivo, puedes usar una URL externa</small>
                    </div>
                    <button type="submit" class="btn-admin">
                        <i class="fas fa-save"></i> Guardar en Galer√≠a
                    </button>
                </form>
                
                <!-- Barra de progreso para subida -->
                <div id="uploadProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <small id="uploadStatus" class="text-muted">Preparando subida...</small>
                </div>
                
                <hr>
                <h4>Contenido de Galer√≠a</h4>
                <div id="galeriaList"></div>
            </div>
        </div>

        <!-- Modal de Edici√≥n de Galer√≠a -->
        <div class="modal fade" id="editGaleriaModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Editar Elemento de Galer√≠a</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editGaleriaForm">
                            <input type="hidden" id="editGaleriaId">
                            <div class="form-group">
                                <label for="editGaleriaTitulo">T√≠tulo</label>
                                <input type="text" class="form-control" id="editGaleriaTitulo" required>
                            </div>
                            <div class="form-group">
                                <label for="editGaleriaDescripcion">Descripci√≥n</label>
                                <textarea class="form-control" id="editGaleriaDescripcion" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="editGaleriaTipo">Tipo</label>
                                <select class="form-control" id="editGaleriaTipo" required>
                                    <option value="imagen">Imagen</option>
                                    <option value="video">Video</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editGaleriaUrl">URL del Archivo</label>
                                <input type="url" class="form-control" id="editGaleriaUrl" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="updateGaleria()">Guardar Cambios</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="storage-manager.js"></script>
    <script src="data-cleaner.js"></script>
    <script src="emergency-clean.js"></script>
    <script src="manual-debug.js"></script>
    <script>
        
        // Funci√≥n de debug manual
        window.debugClean = function() {
            console.log('üîç Iniciando limpieza manual con debug...');
            if (confirm('üîç DEBUG MANUAL: Esto limpiar√° todo y mostrar√° resultados detallados paso a paso. ¬øContinuar?')) {
                window.manualDebugClean();
            }
        };
        
        // Funci√≥n de emergencia
        window.emergencyClean = function() {
            if (confirm('‚ö†Ô∏è EMERGENCIA: Esto eliminar√° ABSOLUTAMENTE TODO y recargar√° la p√°gina. ¬øContinuar?')) {
                // Cargar y ejecutar limpieza de emergencia
                const script = document.createElement('script');
                script.src = 'emergency-clean.js';
                script.onload = () => {
                    console.log('üö® Limpieza de emergencia iniciada');
                };
                document.head.appendChild(script);
            }
        };
        // Sistema de gesti√≥n de contenido con almacenamiento ilimitado
        class ContentManager {
            constructor() {
                this.data = {
                    anuncios: [],
                    eventos: [],
                    predicas: [],
                    galeria: []
                };
                this.loadData();
            }

            async loadData() {
                try {
                    // Cargar datos desde IndexedDB
                    this.data.anuncios = await window.storageManager.getAllContent('anuncios');
                    this.data.eventos = await window.storageManager.getAllContent('eventos');
                    this.data.predicas = await window.storageManager.getAllContent('predicas');
                    this.data.galeria = await window.storageManager.getAllContent('galeria');
                    
                    // Tambi√©n mantener compatibilidad con localStorage
                    const savedData = localStorage.getItem('casaOracionData');
                    if (savedData && !this.data.anuncios.length) {
                        const localData = JSON.parse(savedData);
                        this.data = localData;
                        // Migrar datos a IndexedDB
                        await this.migrateToIndexedDB();
                    }
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    // Fallback a localStorage
                    const savedData = localStorage.getItem('casaOracionData');
                    if (savedData) {
                        this.data = JSON.parse(savedData);
                    }
                }
            }

            async migrateToIndexedDB() {
                try {
                    console.log('üîÑ Iniciando migraci√≥n a IndexedDB...');
                    
                    // Limpiar IndexedDB primero para evitar conflictos
                    await this.cleanIndexedDB();
                    
                    // Migrar datos con manejo de errores
                    for (const anuncio of this.data.anuncios) {
                        try {
                            await window.storageManager.saveContent('anuncios', {...anuncio});
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error migrando anuncio:', error);
                        }
                    }
                    
                    for (const evento of this.data.eventos) {
                        try {
                            await window.storageManager.saveContent('eventos', {...evento});
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error migrando evento:', error);
                        }
                    }
                    
                    for (const predica of this.data.predicas) {
                        try {
                            await window.storageManager.saveContent('predicas', {...predica});
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error migrando predica:', error);
                        }
                    }
                    
                    for (const item of this.data.galeria) {
                        try {
                            await window.storageManager.saveContent('galeria', {...item});
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error migrando galer√≠a:', error);
                        }
                    }
                    
                    console.log('‚úÖ Migraci√≥n a IndexedDB completada');
                    
                    // Limpiar localStorage despu√©s de migraci√≥n exitosa
                    localStorage.removeItem('casaOracionData');
                    
                } catch (error) {
                    console.error('‚ùå Error cr√≠tico en migraci√≥n:', error);
                    // Si falla la migraci√≥n, continuar con localStorage
                }
            }

            async cleanIndexedDB() {
                try {
                    return new Promise((resolve, reject) => {
                        const deleteRequest = indexedDB.deleteDatabase('CasaOracionDB');
                        deleteRequest.onsuccess = () => {
                            console.log('üßπ IndexedDB limpiado para migraci√≥n');
                            resolve();
                        };
                        deleteRequest.onerror = () => reject(deleteRequest.error);
                    });
                } catch (error) {
                    console.error('Error limpiando IndexedDB:', error);
                }
            }

            async saveData() {
                try {
                    // Guardar en IndexedDB
                    for (const anuncio of this.data.anuncios) {
                        await window.storageManager.updateContent('anuncios', anuncio.id, anuncio);
                    }
                    for (const evento of this.data.eventos) {
                        await window.storageManager.updateContent('eventos', evento.id, evento);
                    }
                    for (const predica of this.data.predicas) {
                        await window.storageManager.updateContent('predicas', predica.id, predica);
                    }
                    for (const item of this.data.galeria) {
                        await window.storageManager.updateContent('galeria', item.id, item);
                    }
                    
                    // Tambi√©n guardar en localStorage como backup
                    localStorage.setItem('casaOracionData', JSON.stringify(this.data));
                } catch (error) {
                    console.error('Error guardando datos:', error);
                    // Fallback a localStorage
                    localStorage.setItem('casaOracionData', JSON.stringify(this.data));
                }
            }

            async addAnuncio(anuncio) {
                try {
                    anuncio.id = Date.now();
                    await window.storageManager.saveContent('anuncios', anuncio);
                    this.data.anuncios.push(anuncio);
                    await this.saveData();
                    this.renderAnuncios();
                    showNotification('Anuncio agregado exitosamente', 'success');
                } catch (error) {
                    console.error('Error agregando anuncio:', error);
                    showNotification('Error al agregar anuncio', 'danger');
                }
            }

            async addEvento(evento) {
                try {
                    evento.id = Date.now();
                    await window.storageManager.saveContent('eventos', evento);
                    this.data.eventos.push(evento);
                    await this.saveData();
                    this.renderEventos();
                    showNotification('Evento agregado exitosamente', 'success');
                } catch (error) {
                    console.error('Error agregando evento:', error);
                    showNotification('Error al agregar evento', 'danger');
                }
            }

            async addPredica(predica) {
                try {
                    predica.id = Date.now();
                    await window.storageManager.saveContent('predicas', predica);
                    this.data.predicas.push(predica);
                    await this.saveData();
                    this.renderPredicas();
                    showNotification('Predicaci√≥n agregada exitosamente', 'success');
                } catch (error) {
                    console.error('Error agregando predica:', error);
                    showNotification('Error al agregar predica', 'danger');
                }
            }

            async addGaleria(item) {
                try {
                    item.id = Date.now();
                    await window.storageManager.saveContent('galeria', item);
                    this.data.galeria.push(item);
                    await this.saveData();
                    this.renderGaleria();
                    showNotification('Elemento agregado a galer√≠a exitosamente', 'success');
                } catch (error) {
                    console.error('Error agregando a galer√≠a:', error);
                    showNotification('Error al agregar a galer√≠a', 'danger');
                }
            }

            async deleteItem(type, id) {
                try {
                    await window.storageManager.deleteContent(type, id);
                    this.data[type] = this.data[type].filter(item => item.id !== id);
                    await this.saveData();
                    this.renderAll();
                    showNotification('Elemento eliminado exitosamente', 'success');
                } catch (error) {
                    console.error('Error eliminando elemento:', error);
                    showNotification('Error al eliminar elemento', 'danger');
                }
            }

            renderAnuncios() {
                const container = document.getElementById('anunciosList');
                container.innerHTML = '';
                
                this.data.anuncios.forEach(anuncio => {
                    const item = document.createElement('div');
                    item.className = 'alert alert-info';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5>${anuncio.titulo}</h5>
                                <p>${anuncio.contenido}</p>
                                <small>Fecha: ${anuncio.fecha}</small>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-warning" onclick="editAnuncio(${anuncio.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('anuncios', ${anuncio.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            renderEventos() {
                const container = document.getElementById('eventosList');
                container.innerHTML = '';
                
                this.data.eventos.forEach(evento => {
                    const item = document.createElement('div');
                    item.className = 'alert alert-warning';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5>${evento.titulo}</h5>
                                <p>${evento.descripcion}</p>
                                <small>Fecha: ${evento.fecha} - Hora: ${evento.hora}</small>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-warning" onclick="editEvento(${evento.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('eventos', ${evento.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            renderPredicas() {
                const container = document.getElementById('predicasList');
                container.innerHTML = '';
                
                this.data.predicas.forEach(predica => {
                    const item = document.createElement('div');
                    item.className = 'alert alert-success';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5>${predica.titulo}</h5>
                                <p><strong>Predicador:</strong> ${predica.predicador}</p>
                                <p>${predica.descripcion}</p>
                                <small>Fecha: ${predica.fecha}</small>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-warning" onclick="editPredica(${predica.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('predicas', ${predica.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            renderGaleria() {
                const container = document.getElementById('galeriaList');
                container.innerHTML = '';
                
                this.data.galeria.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'alert alert-secondary';
                    div.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h5>${item.titulo}</h5>
                                <p>${item.descripcion}</p>
                                <small>Tipo: ${item.tipo}</small><br>
                                <small>URL: ${item.url}</small>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-warning" onclick="editGaleria(${item.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteItem('galeria', ${item.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            renderAll() {
                this.renderAnuncios();
                this.renderEventos();
                this.renderPredicas();
                this.renderGaleria();
            }
        }

        // Inicializar el gestor de contenido
        const contentManager = new ContentManager();

        // Funciones de navegaci√≥n
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        // Manejo de formularios
        document.getElementById('anuncioForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const anuncio = {
                titulo: document.getElementById('anuncioTitulo').value,
                contenido: document.getElementById('anuncioContenido').value,
                fecha: document.getElementById('anuncioFecha').value
            };
            contentManager.addAnuncio(anuncio);
            this.reset();
        });

        document.getElementById('eventoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const evento = {
                titulo: document.getElementById('eventoTitulo').value,
                descripcion: document.getElementById('eventoDescripcion').value,
                fecha: document.getElementById('eventoFecha').value,
                hora: document.getElementById('eventoHora').value
            };
            contentManager.addEvento(evento);
            this.reset();
        });

        document.getElementById('predicaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const predica = {
                titulo: document.getElementById('predicaTitulo').value,
                predicador: document.getElementById('predicaPredicador').value,
                descripcion: document.getElementById('predicaDescripcion').value,
                fecha: document.getElementById('predicaFecha').value
            };
            contentManager.addPredica(predica);
            this.reset();
        });

        document.getElementById('galeriaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('galeriaArchivo');
            const urlInput = document.getElementById('galeriaUrl').value;
            
            if (fileInput.files.length > 0) {
                // Procesar archivo subido con el nuevo sistema
                const file = fileInput.files[0];
                const metadata = {
                    titulo: document.getElementById('galeriaTitulo').value,
                    descripcion: document.getElementById('galeriaDescripcion').value,
                    tipo: document.getElementById('galeriaTipo').value
                };
                
                // Mostrar barra de progreso
                const progressDiv = document.getElementById('uploadProgress');
                const progressBar = document.getElementById('progressBar');
                const uploadStatus = document.getElementById('uploadStatus');
                
                progressDiv.style.display = 'block';
                uploadStatus.textContent = `Subiendo ${file.name} (${formatFileSize(file.size)})...`;
                
                try {
                    // Simular progreso (en un sistema real, esto vendr√≠a del servidor)
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 15;
                        if (progress > 90) progress = 90;
                        progressBar.style.width = progress + '%';
                        progressBar.textContent = Math.round(progress) + '%';
                    }, 200);
                    
                    // Guardar archivo usando StorageManager
                    const fileId = await window.storageManager.saveFile(file, metadata);
                    
                    // Completar progreso
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100%';
                    uploadStatus.textContent = '¬°Archivo subido exitosamente!';
                    
                    // Crear item para galer√≠a
                    const item = {
                        ...metadata,
                        url: `file:${fileId}`, // Referencia al archivo guardado
                        fileName: file.name,
                        fileSize: file.size,
                        uploadDate: new Date().toISOString()
                    };
                    
                    await contentManager.addGaleria(item);
                    
                    // Ocultar barra de progreso despu√©s de 2 segundos
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        progressBar.style.width = '0%';
                        progressBar.textContent = '0%';
                    }, 2000);
                    
                    this.reset();
                    updateStorageStats(); // Actualizar estad√≠sticas
                    
                } catch (error) {
                    console.error('Error subiendo archivo:', error);
                    uploadStatus.textContent = 'Error al subir archivo: ' + error.message;
                    progressBar.classList.add('bg-danger');
                    
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        progressBar.classList.remove('bg-danger');
                        progressBar.style.width = '0%';
                        progressBar.textContent = '0%';
                    }, 3000);
                }
                
            } else if (urlInput) {
                // Usar URL proporcionada
                const item = {
                    titulo: document.getElementById('galeriaTitulo').value,
                    descripcion: document.getElementById('galeriaDescripcion').value,
                    tipo: document.getElementById('galeriaTipo').value,
                    url: urlInput,
                    uploadDate: new Date().toISOString()
                };
                await contentManager.addGaleria(item);
                this.reset();
                updateStorageStats();
            } else {
                showNotification('Por favor selecciona un archivo o ingresa una URL', 'warning');
                return;
            }
        });

        // Funci√≥n para formatear tama√±o de archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Funci√≥n para actualizar estad√≠sticas de almacenamiento
        async function updateStorageStats() {
            try {
                const stats = await window.storageManager.getStorageStats();
                if (stats) {
                    document.getElementById('totalSpace').textContent = formatFileSize(stats.quota);
                    document.getElementById('usedSpace').textContent = formatFileSize(stats.usage);
                    document.getElementById('availableSpace').textContent = formatFileSize(stats.available);
                    document.getElementById('usagePercentage').textContent = stats.usagePercentage + '%';
                    
                    // Cambiar color seg√∫n porcentaje de uso
                    const usageElement = document.getElementById('usagePercentage');
                    usageElement.className = 'badge ';
                    if (parseFloat(stats.usagePercentage) < 50) {
                        usageElement.className += 'bg-success';
                    } else if (parseFloat(stats.usagePercentage) < 80) {
                        usageElement.className += 'bg-warning';
                    } else {
                        usageElement.className += 'bg-danger';
                    }
                } else {
                    // Si no hay estad√≠sticas disponibles, mostrar mensaje
                    document.getElementById('totalSpace').textContent = 'Ilimitado';
                    document.getElementById('usedSpace').textContent = 'N/A';
                    document.getElementById('availableSpace').textContent = 'Ilimitado';
                    document.getElementById('usagePercentage').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Error obteniendo estad√≠sticas:', error);
            }
        }

        // Funciones de edici√≥n
        window.editAnuncio = function(id) {
            const anuncio = contentManager.data.anuncios.find(a => a.id === id);
            if (anuncio) {
                document.getElementById('editAnuncioId').value = anuncio.id;
                document.getElementById('editAnuncioTitulo').value = anuncio.titulo;
                document.getElementById('editAnuncioContenido').value = anuncio.contenido;
                document.getElementById('editAnuncioFecha').value = anuncio.fecha;
                
                const modal = new bootstrap.Modal(document.getElementById('editAnuncioModal'));
                modal.show();
            }
        };

        window.editEvento = function(id) {
            const evento = contentManager.data.eventos.find(e => e.id === id);
            if (evento) {
                document.getElementById('editEventoId').value = evento.id;
                document.getElementById('editEventoTitulo').value = evento.titulo;
                document.getElementById('editEventoDescripcion').value = evento.descripcion;
                document.getElementById('editEventoFecha').value = evento.fecha;
                document.getElementById('editEventoHora').value = evento.hora;
                
                const modal = new bootstrap.Modal(document.getElementById('editEventoModal'));
                modal.show();
            }
        };

        window.editPredica = function(id) {
            const predica = contentManager.data.predicas.find(p => p.id === id);
            if (predica) {
                document.getElementById('editPredicaId').value = predica.id;
                document.getElementById('editPredicaTitulo').value = predica.titulo;
                document.getElementById('editPredicaPredicador').value = predica.predicador;
                document.getElementById('editPredicaDescripcion').value = predica.descripcion;
                document.getElementById('editPredicaFecha').value = predica.fecha;
                
                const modal = new bootstrap.Modal(document.getElementById('editPredicaModal'));
                modal.show();
            }
        };

        window.editGaleria = function(id) {
            const item = contentManager.data.galeria.find(g => g.id === id);
            if (item) {
                document.getElementById('editGaleriaId').value = item.id;
                document.getElementById('editGaleriaTitulo').value = item.titulo;
                document.getElementById('editGaleriaDescripcion').value = item.descripcion;
                document.getElementById('editGaleriaTipo').value = item.tipo;
                document.getElementById('editGaleriaUrl').value = item.url;
                
                const modal = new bootstrap.Modal(document.getElementById('editGaleriaModal'));
                modal.show();
            }
        };

        // Funciones de actualizaci√≥n
        window.updateAnuncio = function() {
            const id = parseInt(document.getElementById('editAnuncioId').value);
            const anuncioIndex = contentManager.data.anuncios.findIndex(a => a.id === id);
            
            if (anuncioIndex !== -1) {
                contentManager.data.anuncios[anuncioIndex] = {
                    id: id,
                    titulo: document.getElementById('editAnuncioTitulo').value,
                    contenido: document.getElementById('editAnuncioContenido').value,
                    fecha: document.getElementById('editAnuncioFecha').value
                };
                
                contentManager.saveData();
                contentManager.renderAnuncios();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editAnuncioModal'));
                modal.hide();
                
                showNotification('Anuncio actualizado exitosamente', 'success');
            }
        };

        window.updateEvento = function() {
            const id = parseInt(document.getElementById('editEventoId').value);
            const eventoIndex = contentManager.data.eventos.findIndex(e => e.id === id);
            
            if (eventoIndex !== -1) {
                contentManager.data.eventos[eventoIndex] = {
                    id: id,
                    titulo: document.getElementById('editEventoTitulo').value,
                    descripcion: document.getElementById('editEventoDescripcion').value,
                    fecha: document.getElementById('editEventoFecha').value,
                    hora: document.getElementById('editEventoHora').value
                };
                
                contentManager.saveData();
                contentManager.renderEventos();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editEventoModal'));
                modal.hide();
                
                showNotification('Evento actualizado exitosamente', 'success');
            }
        };

        window.updatePredica = function() {
            const id = parseInt(document.getElementById('editPredicaId').value);
            const predicaIndex = contentManager.data.predicas.findIndex(p => p.id === id);
            
            if (predicaIndex !== -1) {
                contentManager.data.predicas[predicaIndex] = {
                    id: id,
                    titulo: document.getElementById('editPredicaTitulo').value,
                    predicador: document.getElementById('editPredicaPredicador').value,
                    descripcion: document.getElementById('editPredicaDescripcion').value,
                    fecha: document.getElementById('editPredicaFecha').value
                };
                
                contentManager.saveData();
                contentManager.renderPredicas();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editPredicaModal'));
                modal.hide();
                
                showNotification('Predicaci√≥n actualizada exitosamente', 'success');
            }
        };

        window.updateGaleria = function() {
            const id = parseInt(document.getElementById('editGaleriaId').value);
            const galeriaIndex = contentManager.data.galeria.findIndex(g => g.id === id);
            
            if (galeriaIndex !== -1) {
                contentManager.data.galeria[galeriaIndex] = {
                    id: id,
                    titulo: document.getElementById('editGaleriaTitulo').value,
                    descripcion: document.getElementById('editGaleriaDescripcion').value,
                    tipo: document.getElementById('editGaleriaTipo').value,
                    url: document.getElementById('editGaleriaUrl').value
                };
                
                contentManager.saveData();
                contentManager.renderGaleria();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editGaleriaModal'));
                modal.hide();
                
                showNotification('Elemento de galer√≠a actualizado exitosamente', 'success');
            }
        };

        // Funci√≥n de notificaci√≥n
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', async function() {
            await contentManager.loadData();
            contentManager.renderAll();
            showSection('galeria'); // Mostrar galer√≠a por defecto para ver las estad√≠sticas
            updateStorageStats(); // Actualizar estad√≠sticas de almacenamiento
            
            // Actualizar estad√≠sticas cada 30 segundos
            setInterval(updateStorageStats, 30000);
        });
    </script>
</body>
</html>
